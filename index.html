<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>PW Gulf | Student Dashboard</title>

<!-- DataTables + Papa Parse -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/datatables.net-dt@1.13.8/css/jquery.dataTables.min.css">
<script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/datatables.net@1.13.8/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
  :root{
    --bg:#f6f8fb; --card:#ffffff; --ink:#0f172a; --muted:#6b7280;
    --accent:#2563eb; --accent2:#1e40af; --ok:#16a34a; --warn:#f59e0b; --danger:#ef4444;
    --line:#e5e7eb;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}

  /* Header */
  .site-header{
    position:sticky; top:0; z-index:1000;
    display:grid; grid-template-columns:auto 1fr auto; align-items:center; gap:12px;
    padding:14px 18px; color:#fff;
    background:linear-gradient(90deg,var(--accent2),var(--accent),var(--accent2));
    box-shadow:0 8px 18px rgba(37,99,235,.25);
  }
  .site-header .logo{height:40px;width:auto;border-radius:6px;box-shadow:0 0 0 2px rgba(255,255,255,.18)}
  .site-header h1{margin:0;text-align:center;font-size:18px;letter-spacing:.2px;font-weight:800}
  .header-spacer{width:40px}
  @media(max-width:640px){
    .site-header{grid-template-columns:1fr; text-align:center}
    .header-spacer{display:none}
    .site-header h1{font-size:16px}
    .site-header .logo{justify-self:center}
  }

  /* Layout */
  .wrap{max-width:1200px;margin:0 auto;padding:16px}
  .tabs{display:flex;gap:8px;flex-wrap:wrap}
  .tab-btn{
    background:#fff;border:1px solid var(--line);color:var(--ink);
    padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:600
  }
  .tab-btn.active{background:var(--accent);color:#fff;border-color:transparent}
  .panel{margin-top:12px;background:var(--card);border:1px solid var(--line);border-radius:12px;padding:14px;box-shadow:0 6px 14px rgba(0,0,0,.06)}

  /* KPI cards */
  .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin:10px 0 16px}
  .kpi{background:#fff;border:1px solid var(--line);border-radius:12px;padding:12px}
  .kpi-label{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.04em}
  .kpi-value{font-size:26px;font-weight:800;line-height:1.1;margin-top:2px}
  .kpi.accent{border-left:4px solid var(--accent)}
  .kpi.ok{border-left:4px solid var(--ok)}
  .kpi.warn{border-left:4px solid var(--warn)}
  .kpi.danger{border-left:4px solid var(--danger)}
  @media(max-width:800px){ .kpis{grid-template-columns:repeat(2,1fr)} }

  /* Controls */
  .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:10px}
  .controls select,.controls input{
    padding:8px 10px;border:1px solid var(--line);border-radius:8px;background:#fff
  }
  .controls button{
    border:0;border-radius:10px;padding:8px 12px;background:var(--accent);color:#fff;font-weight:700;cursor:pointer
  }
  .controls .secondary{background:#eef2ff;color:#1e3a8a}

  /* DataTable tweaks */
  table.dataTable thead th{background:#f8fafc}
  .dataTables_wrapper .dataTables_filter input{border:1px solid var(--line); border-radius:8px; padding:6px 8px}
  .status-pill{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;font-weight:700}
  .status-new{background:#e0ecff;color:#1d4ed8}
  .status-wip{background:#fff7ed;color:#b45309}
  .status-resolved{background:#ecfdf5;color:#047857}

  .help{font-size:12px;color:var(--muted)}
</style>
</head>
<body>

<header class="site-header">
  <img class="logo" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQC..." alt="Logo" />
  <h1>PW Gulf â€” Student Performance Dashboard</h1>
  <div class="header-spacer"></div>
</header>

<div class="wrap">

  <!-- Tabs -->
  <div class="tabs">
    <button class="tab-btn active" data-tab="attendance">Attendance</button>
    <button class="tab-btn" data-tab="objective">Objective Tests</button>
    <button class="tab-btn" data-tab="subjective">Subjective Tests</button>
  </div>

  <!-- ATTENDANCE -->
  <section id="attendance" class="panel">
    <div class="controls">
      <button id="refreshAttendance" class="secondary" type="button">Refresh</button>
      <span class="help">KPIs are computed from the loaded CSV rows.</span>
    </div>

    <div class="kpis">
      <div class="kpi accent">
        <div class="kpi-label">Total Students (Unique)</div>
        <div id="attTotalStudents" class="kpi-value">0</div>
      </div>
      <div class="kpi ok">
        <div class="kpi-label">Present %</div>
        <div id="attPresentPct" class="kpi-value">0%</div>
      </div>
      <div class="kpi warn">
        <div class="kpi-label">Absent %</div>
        <div id="attAbsentPct" class="kpi-value">0%</div>
      </div>
      <div class="kpi accent">
        <div class="kpi-label">Attendance %</div>
        <div id="attAttendancePct" class="kpi-value">0%</div>
      </div>
    </div>

    <table id="attendanceTable" class="display" style="width:100%"></table>
  </section>

  <!-- OBJECTIVE -->
  <section id="objective" class="panel" style="display:none">
    <div class="controls">
      <select id="objNameFilter">
        <option value="__ALL__">All Objective Names</option>
      </select>
      <button id="refreshObjective" class="secondary" type="button">Refresh</button>
      <span class="help">Filter by Objective Name to update the KPIs below.</span>
    </div>

    <div class="kpis">
      <div class="kpi accent"><div class="kpi-label">Total Students (Unique)</div><div id="objTotal" class="kpi-value">0</div></div>
      <div class="kpi ok"><div class="kpi-label">Average Score</div><div id="objAvg" class="kpi-value">0%</div></div>
      <div class="kpi accent"><div class="kpi-label">Max %</div><div id="objMax" class="kpi-value">0%</div></div>
      <div class="kpi warn"><div class="kpi-label">Min %</div><div id="objMin" class="kpi-value">0%</div></div>
    </div>

    <table id="objectiveTable" class="display" style="width:100%"></table>
  </section>

  <!-- SUBJECTIVE -->
  <section id="subjective" class="panel" style="display:none">
    <div class="controls">
      <select id="subWeekFilter">
        <option value="__ALL__">All Weeks</option>
      </select>
      <button id="refreshSubjective" class="secondary" type="button">Refresh</button>
      <span class="help">Week filter uses ISO week derived from Test Result Date.</span>
    </div>

    <div class="kpis">
      <div class="kpi accent"><div class="kpi-label">Total Students (Unique)</div><div id="subTotal" class="kpi-value">0</div></div>
      <div class="kpi ok"><div class="kpi-label">Average Marks</div><div id="subAvg" class="kpi-value">0%</div></div>
      <div class="kpi accent"><div class="kpi-label">Max %</div><div id="subMax" class="kpi-value">0%</div></div>
      <div class="kpi warn"><div class="kpi-label">Min %</div><div id="subMin" class="kpi-value">0%</div></div>
    </div>

    <table id="subjectiveTable" class="display" style="width:100%"></table>
  </section>

</div>

<script>
/* ====================== CONFIG: UPDATE THESE CSV LINKS ====================== */
const CSV_ATTENDANCE_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRAlfVnrnY4xye72jsXLtGwuBRKl51Xo24re0TScU-AD7aWpgFEgJtOQOrO9lzgFzpTuubnXNBvKwAZ/pub?gid=0&single=true&output=csv";
const CSV_OBJECTIVE_URL  = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRAlfVnrnY4xye72jsXLtGwuBRKl51Xo24re0TScU-AD7aWpgFEgJtOQOrO9lzgFzpTuubnXNBvKwAZ/pub?gid=1944265869&single=true&output=csv";
const CSV_SUBJECTIVE_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRAlfVnrnY4xye72jsXLtGwuBRKl51Xo24re0TScU-AD7aWpgFEgJtOQOrO9lzgFzpTuubnXNBvKwAZ/pub?gid=1445613757&single=true&output=csv";

/* Optional: column names (in case your headers vary slightly).
   Attendance is flexible: it looks for a student name column and a status column.
*/
const ATTENDANCE_NAME_KEYS  = ["Student Name","Student Names","Name"]; // try in order
const ATTENDANCE_STATUS_KEYS= ["Status","Attendance","Present/Absent"]; // try in order
const ATTENDANCE_PRESENT_VALUES = ["present","p","yes","1"]; // case-insensitive
/* ========================================================================== */

/* ---------- Helpers ---------- */
const pct = (n)=> (isFinite(n) ? (Math.round(n*10000)/100).toFixed(2)+"%" : "0%");
const num = (v)=> {
  if (v==null) return 0;
  if (typeof v === "number") return v;
  const s = String(v).trim().replace(/[,]/g,"");
  if (/^-?\d+(\.\d+)?$/.test(s)) return parseFloat(s);
  if (/%$/.test(s)) return parseFloat(s.replace("%",""));
  return parseFloat(s) || 0;
};
const parseDate = (s)=>{
  // Accepts formats like "22-Jul-2025" or "20 Jun, 2025"
  if (!s) return null;
  const try1 = Date.parse(s);
  if (!isNaN(try1)) return new Date(try1);
  // try dd-MMM-yyyy manually
  const m = String(s).match(/^(\d{1,2})[-\s]([A-Za-z]{3,})[-,\s]+(\d{4})$/);
  if (m){
    const map = {jan:0,feb:1,mar:2,apr:3,may:4,jun:5,jul:6,aug:7,sep:8,oct:9,nov:10,dec:11};
    const d = parseInt(m[1],10); const mon = map[m[2].toLowerCase().slice(0,3)]; const y = parseInt(m[3],10);
    if (mon>=0) return new Date(y, mon, d);
  }
  return null;
};
const isoWeek = (date)=>{
  // https://en.wikipedia.org/wiki/ISO_week_date#Algorithms
  const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
  const dayNum = (d.getUTCDay() + 6) % 7;
  d.setUTCDate(d.getUTCDate() - dayNum + 3);
  const firstThursday = new Date(Date.UTC(d.getUTCFullYear(),0,4));
  const diff = d - firstThursday;
  return 1 + Math.round(diff / (7*24*3600*1000));
};

function findColumnIndex(header, candidates){
  for (const key of candidates){
    const idx = header.findIndex(h => h.trim().toLowerCase() === key.trim().toLowerCase());
    if (idx !== -1) return idx;
  }
  // fuzzy contains
  for (const key of candidates){
    const idx = header.findIndex(h => h.toLowerCase().includes(key.toLowerCase()));
    if (idx !== -1) return idx;
  }
  return -1;
}

function uniqueCount(rows, idx){
  const set = new Set();
  rows.forEach(r => { const v = (r[idx]||"").trim(); if (v) set.add(v); });
  return set.size;
}

function statusIsPresent(s){
  if (!s) return false;
  const v = String(s).trim().toLowerCase();
  return ATTENDANCE_PRESENT_VALUES.includes(v);
}

/* ---------- DataTables holders ---------- */
let attTable=null, objTable=null, subTable=null;

/* ================= ATTENDANCE ================= */
async function loadAttendance(){
  const res = await fetch(CSV_ATTENDANCE_URL + (CSV_ATTENDANCE_URL.includes("?") ? "&" : "?") + "_=" + Date.now(), {cache:"no-store"});
  const csv = await res.text();
  const parsed = Papa.parse(csv, {header:true, skipEmptyLines:true});
  const header = parsed.meta.fields || [];
  const data = parsed.data || [];

  // find columns
  const nameIdx   = findColumnIndex(header, ATTENDANCE_NAME_KEYS);
  const statusIdx = findColumnIndex(header, ATTENDANCE_STATUS_KEYS);

  // KPIs
  const totalRows = data.length;
  const totalStudents = (nameIdx>-1) ? uniqueCount(data.map(r=>header.map(h=>r[h])), nameIdx) : 0;
  let presentRows = 0;
  if (statusIdx>-1){
    for (const r of data){
      const arr = header.map(h=>r[h]);
      if (statusIsPresent(arr[statusIdx])) presentRows++;
    }
  }
  const presentPct = totalRows ? (presentRows/totalRows) : 0;
  const absentPct  = 1 - presentPct;

  document.getElementById('attTotalStudents').textContent = totalStudents;
  document.getElementById('attPresentPct').textContent    = pct(presentPct);
  document.getElementById('attAbsentPct').textContent     = pct(absentPct);
  document.getElementById('attAttendancePct').textContent = pct(presentPct);

  // Build table columns dynamically
  const columns = header.map(h => ({title:h, data:h}));
  if (attTable){ attTable.clear().destroy(); }
  attTable = $('#attendanceTable').DataTable({
    data,
    columns,
    pageLength: 10,
    responsive: true,
    order: [],
  });
}

/* ================= OBJECTIVE ================= */
// Expected headers (exact spellings from you):
// "Test Result Date","Objective Name","Student Names","Registered Student Names","Admission Dates","Grades","Sections","Streams","Batchs","Countrys","Total Eligible","Total Participants","Total Absent","Avg. Participation","Physics","Chemistry","Maths","Zoology","Botany","Marks Achieved","SUBJECTS","Total Marks","Test Percentage"
let objectiveRaw = [];

async function loadObjective(){
  const res = await fetch(CSV_OBJECTIVE_URL + (CSV_OBJECTIVE_URL.includes("?") ? "&" : "?") + "_=" + Date.now(), {cache:"no-store"});
  const csv = await res.text();
  const parsed = Papa.parse(csv, {header:true, skipEmptyLines:true});
  const header = parsed.meta.fields || [];
  objectiveRaw = parsed.data || [];

  // fill Objective Name filter
  const nameSet = new Set();
  objectiveRaw.forEach(r => { if (r["Objective Name"]) nameSet.add(r["Objective Name"]); });
  const sel = document.getElementById('objNameFilter');
  const current = sel.value;
  sel.innerHTML = `<option value="__ALL__">All Objective Names</option>` + 
                  [...nameSet].map(n=>`<option value="${String(n).replace(/"/g,'&quot;')}">${n}</option>`).join("");
  if ([...nameSet].includes(current)) sel.value = current; else sel.value="__ALL__";

  renderObjectiveTableAndKpis();
}

function renderObjectiveTableAndKpis(){
  const filterName = document.getElementById('objNameFilter').value;
  let rows = objectiveRaw;
  if (filterName !== "__ALL__"){
    rows = rows.filter(r => String(r["Objective Name"]||"") === filterName);
  }

  // KPIs
  const uniqStudents = new Set(rows.map(r => (r["Student Names"]||"").trim()).filter(Boolean)).size;
  let sumAch=0, sumTot=0, maxPct=-Infinity, minPct=Infinity;

  rows.forEach(r=>{
    const ach = num(r["Marks Achieved"]);
    const tot = num(r["Total Marks"]);
    sumAch += ach; sumTot += (tot||0);

    const tp = num(r["Test Percentage"]); // already % string or number
    if (isFinite(tp)){
      if (tp>maxPct) maxPct = tp;
      if (tp<minPct) minPct = tp;
    }
  });

  document.getElementById('objTotal').textContent = uniqStudents || 0;
  document.getElementById('objAvg').textContent   = (sumTot>0) ? (Math.round((sumAch/sumTot)*10000)/100).toFixed(2)+"%" : "0%";
  document.getElementById('objMax').textContent   = isFinite(maxPct) ? (Math.round(maxPct*100)/100).toFixed(2)+"%" : "0%";
  document.getElementById('objMin').textContent   = isFinite(minPct) ? (Math.round(minPct*100)/100).toFixed(2)+"%" : "0%";

  // Table
  const header = objectiveRaw.length ? Object.keys(objectiveRaw[0]) : [];
  const columns = header.map(h => ({title:h, data:h}));
  if (objTable){ objTable.clear().destroy(); }
  objTable = $('#objectiveTable').DataTable({
    data: rows,
    columns,
    pageLength: 10,
    responsive: true,
    order: [],
  });
}

/* ================= SUBJECTIVE ================= */
// We assume Subjective CSV has similar columns to Objective: it MUST have
// "Test Result Date","Student Names","Marks Achieved","Total Marks","Test Percentage"
// If names differ slightly, you can remap below in code.
let subjectiveRaw = [];

async function loadSubjective(){
  const res = await fetch(CSV_SUBJECTIVE_URL + (CSV_SUBJECTIVE_URL.includes("?") ? "&" : "?") + "_=" + Date.now(), {cache:"no-store"});
  const csv = await res.text();
  const parsed = Papa.parse(csv, {header:true, skipEmptyLines:true});
  const header = parsed.meta.fields || [];
  subjectiveRaw = parsed.data || [];

  // Add derived Week column
  subjectiveRaw.forEach(r=>{
    const d = parseDate(r["Test Result Date"]);
    r.__Week = d ? isoWeek(d) : "";
  });

  // fill week filter
  const weekSet = new Set(subjectiveRaw.map(r=>r.__Week).filter(Boolean));
  const sel = document.getElementById('subWeekFilter');
  const current = sel.value;
  sel.innerHTML = `<option value="__ALL__">All Weeks</option>` + 
                  [...weekSet].sort((a,b)=>a-b).map(w=>`<option value="${w}">Week ${w}</option>`).join("");
  if ([...weekSet].includes(+current)) sel.value = current; else sel.value="__ALL__";

  renderSubjectiveTableAndKpis();
}

function renderSubjectiveTableAndKpis(){
  const week = document.getElementById('subWeekFilter').value;
  let rows = subjectiveRaw;
  if (week !== "__ALL__"){
    rows = rows.filter(r => String(r.__Week) === String(week));
  }

  // KPIs
  const uniqStudents = new Set(rows.map(r => (r["Student Names"]||"").trim()).filter(Boolean)).size;
  let sumAch=0, sumTot=0, maxPct=-Infinity, minPct=Infinity;

  rows.forEach(r=>{
    const ach = num(r["Marks Achieved"]);
    const tot = num(r["Total Marks"]);
    sumAch += ach; sumTot += (tot||0);

    const tp = num(r["Test Percentage"]);
    if (isFinite(tp)){
      if (tp>maxPct) maxPct = tp;
      if (tp<minPct) minPct = tp;
    }
  });

  document.getElementById('subTotal').textContent = uniqStudents || 0;
  document.getElementById('subAvg').textContent   = (sumTot>0) ? (Math.round((sumAch/sumTot)*10000)/100).toFixed(2)+"%" : "0%";
  document.getElementById('subMax').textContent   = isFinite(maxPct) ? (Math.round(maxPct*100)/100).toFixed(2)+"%" : "0%";
  document.getElementById('subMin').textContent   = isFinite(minPct) ? (Math.round(minPct*100)/100).toFixed(2)+"%" : "0%";

  // Table
  const header = subjectiveRaw.length ? Object.keys(subjectiveRaw[0]) : [];
  const columns = header.map(h => ({title: (h==="__Week"?"Week":h), data:h}));
  if (subTable){ subTable.clear().destroy(); }
  subTable = $('#subjectiveTable').DataTable({
    data: rows,
    columns,
    pageLength: 10,
    responsive: true,
    order: [],
  });
}

/* ---------- Tabs ---------- */
document.querySelectorAll('.tab-btn').forEach(btn=>{
  btn.addEventListener('click',()=>{
    document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const tab = btn.dataset.tab;
    document.querySelectorAll('section.panel').forEach(s=> s.style.display='none');
    document.getElementById(tab).style.display='block';
    // Lazy refresh when switching
    if (tab==="attendance" && !attTable) loadAttendance();
    if (tab==="objective" && !objTable) loadObjective();
    if (tab==="subjective" && !subTable) loadSubjective();
  });
});

/* ---------- Listeners ---------- */
document.getElementById('refreshAttendance').addEventListener('click', loadAttendance);
document.getElementById('refreshObjective').addEventListener('click', loadObjective);
document.getElementById('refreshSubjective').addEventListener('click', loadSubjective);

document.getElementById('objNameFilter').addEventListener('change', renderObjectiveTableAndKpis);
document.getElementById('subWeekFilter').addEventListener('change', renderSubjectiveTableAndKpis);

/* ---------- Boot ---------- */
// Load the first tab by default
loadAttendance();
</script>

</body>
</html>
